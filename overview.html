<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-08-12 Sun 16:36 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Human pose estimation using OpenPose</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Sarath.M" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Human pose estimation using OpenPose</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga1c1b78">1. Porting from Caffe to Tensorflow</a></li>
<li><a href="#org5a6cb76">2. Working of OpenPose</a>
<ul>
<li><a href="#orgb399a28">2.1. Parts and Pairs</a></li>
<li><a href="#orgc679fbd">2.2. Tensorflow Implementation</a>
<ul>
<li><a href="#org8ccba9a">2.2.1. Preprocessing</a></li>
<li><a href="#orgab963db">2.2.2. Neural network</a></li>
<li><a href="#org9b11998">2.2.3. Non Maximum Suppression</a></li>
<li><a href="#orge0efd61">2.2.4. Bipartite graph</a></li>
<li><a href="#org2beee76">2.2.5. Line Integral</a></li>
<li><a href="#org0e631fc">2.2.6. Assignment</a></li>
<li><a href="#org8f5ff66">2.2.7. Merging</a></li>
<li><a href="#org650c0c3">2.2.8. Output</a></li>
</ul>
</li>
<li><a href="#orgadf3276">2.3. Github Repository</a>
<ul>
<li><a href="#orgd43eb2d">2.3.1. Installation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orga1c1b78" class="outline-2">
<h2 id="orga1c1b78"><span class="section-number-2">1</span> Porting from Caffe to Tensorflow</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>The OpenPose library is built upon a neural network and has been
developed by Carnegie Mellon University with astounding help of COCO
and MPII datasets</li>
<li><p>
Github repo
</p>
<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/CMU-Perceptual-Computing-Lab/openpose.git
</pre>
</div></li>
<li>OpenPose gathers three sets of trained models: one for body pose
estimation, another one for hands and a last one for faces. And each
set has several models depending on the dataset they have been
trained on (COCO or MPII)</li>
<li>So let’s begin with the body pose estimation model trained on
MPII. We need <b>two files</b>: one that describes the architecture of the
model <a href="https://github.com/CMU-Perceptual-Computing-Lab/openpose/blob/master/models/pose/mpi/pose_deploy_linevec_faster_4_stages.prototxt">(.prototxt)</a> and one that stores the variables values of the
model <a href="http://posefs1.perception.cs.cmu.edu/OpenPose/models/pose/mpi/pose_iter_160000.caffemodel">(.caffemodel)</a></li>
<li><p>
To convert these files to tensorflow use the following repo:
</p>
<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/ethereon/caffe-tensorflow
</pre>
</div>
<p>
The key script here is convert.py, which takes those two files as
arguments along with paths for the new couple of files.
</p>
<div class="org-src-container">
<pre class="src src-sh">convert.py pose_deploy_linevec_faster_4_stages.prototxt <span style="color: #008000;">\</span>
--caffemodel pose_iter_160000.caffemodel --data_output_path data/output/path.npy <span style="color: #008000;">\</span>
--code_output_path code/output/path.py
</pre>
</div></li>
<li><p>
This will return a Python class that describes the architecture
(graph) of the model and an .npy file storing the values of the
TensorFlow variables.
To convert npy file to .ckpt file use
</p>
<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/alesolano/npy2ckpt
</pre>
</div></li>
<li><p>
Finally, here's the openpose code in Tensorflow
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">import</span> tensorflow <span style="color: #0000FF;">as</span> tf
<span style="color: #0000FF;">import</span> cv2

<span style="color: #8D8D84;">### </span><span style="color: #8D8D84; font-style: italic;">GRAPH ###</span>
tf.reset_default_graph<span style="color: #707183;">()</span>

<span style="color: #BA36A5;">saver</span> = tf.train.import_meta_graph<span style="color: #707183;">(</span><span style="color: #008000;">'/tmp/openpose_model.ckpt.meta'</span><span style="color: #707183;">)</span>

<span style="color: #BA36A5;">inputs</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'Placeholder:0'</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">body</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'concat_stage7:0'</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">print</span><span style="color: #707183;">(</span><span style="color: #008000;">'The input placeholder is expecting an array of shape {} and type {}'</span>.<span style="color: #006FE0;">format</span><span style="color: #7388D6;">(</span>inputs.shape, inputs.dtype<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">### </span><span style="color: #8D8D84; font-style: italic;">IMAGE ###</span>
<span style="color: #BA36A5;">img</span> = cv2.imread<span style="color: #707183;">(</span><span style="color: #008000;">'chuck-norris-kick.jpg'</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">img</span> = cv2.cvtColor<span style="color: #707183;">(</span>img, cv2.COLOR_BGR2RGB<span style="color: #707183;">)</span> 
<span style="color: #BA36A5;">res_img</span> = cv2.resize<span style="color: #707183;">(</span>img, <span style="color: #7388D6;">(</span>656, 368<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">prep_img</span> = res_img.reshape<span style="color: #707183;">(</span><span style="color: #7388D6;">[</span>1, 368, 656, 3<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">### </span><span style="color: #8D8D84; font-style: italic;">SESSION ###</span>
<span style="color: #0000FF;">with</span> tf.Session<span style="color: #707183;">()</span> <span style="color: #0000FF;">as</span> sess:
    saver.restore<span style="color: #707183;">(</span>sess, <span style="color: #008000;">'/tmp/openpose_model.ckpt'</span><span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">output_img</span> = sess.run<span style="color: #707183;">(</span>body, feed_dict=<span style="color: #7388D6;">{</span>
            inputs: prep_img
        <span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

<span style="color: #0000FF;">print</span><span style="color: #707183;">(</span>output_img.shape<span style="color: #707183;">)</span>
</pre>
</div></li>
<li>And the result is an image with 57 layers of depth. Mmmm… This is not exactly what I want. Why 57 layers?
<ul class="org-ul">
<li>18 layers for body parts location</li>
<li>1 layer for the background</li>
<li>19 layers for limbs information in the x direction</li>
<li>19 layers for limbs information in the y direction</li>
</ul></li>
<li>Is there a way to combine joints and limbs? Of course. OpenPose is
not just a set of trained neural networks, it’s an entire
library. And one of the functions inside this library is
bodyPartConnectorCaffe.cpp</li>
<li><p>
I’m just researching this right now, and it seems that the
developers of OpenPose have made the work as easiest as
possible. The Caffe code is perfectly isolated and there are only a
few C++ files that depend on Caffe. These files are:
</p>
<blockquote>
<p>
core/maximumCaffe.cpp
core/nmsCaffe.cpp
core/netCaffe.cpp
core/resizeAndMergeCaffe.cpp
pose/poseExtractorCaffe.cpp
pose/bodyPartConnectorCaffe.cpp
</p>
</blockquote></li>
</ul>
</div>
</div>
<div id="outline-container-org5a6cb76" class="outline-2">
<h2 id="org5a6cb76"><span class="section-number-2">2</span> Working of OpenPose</h2>
<div class="outline-text-2" id="text-2">
<p>
<img src="./images/openPose_pipeline.png" alt="openPose_pipeline.png" />
Each part of the pipeline will be explained in the following sections
</p>
</div>
<div id="outline-container-orgb399a28" class="outline-3">
<h3 id="orgb399a28"><span class="section-number-3">2.1</span> Parts and Pairs</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>A body <b>part</b> is an element of the body, like neck, left shoulder or right hip.</li>
<li><p>
A <b>pair</b> is a couple of parts. A connection between parts. We could
say limb, but the connection between the nose and the left eye is
definitely not a limb. Also, we are going to deal with connections
between ears and shoulders that do not exist in real life.
</p>


<div class="figure">
<p><img src="./images/parts_pairs.png" alt="parts_pairs.png" />
</p>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgc679fbd" class="outline-3">
<h3 id="orgc679fbd"><span class="section-number-3">2.2</span> Tensorflow Implementation</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org8ccba9a" class="outline-4">
<h4 id="org8ccba9a"><span class="section-number-4">2.2.1</span> Preprocessing</h4>
<div class="outline-text-4" id="text-2-2-1">
<ul class="org-ul">
<li>First but not least, we convert the image from [0,</li>
</ul>
<p>
255] to [-1, 1].
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">img</span> = img * <span style="color: #707183;">(</span>2.0 / 255.0<span style="color: #707183;">)</span> &#8212; 1.0
</pre>
</div>
</div>
</div>
<div id="outline-container-orgab963db" class="outline-4">
<h4 id="orgab963db"><span class="section-number-4">2.2.2</span> Neural network</h4>
<div class="outline-text-4" id="text-2-2-2">
<ul class="org-ul">
<li><p>
Here we do the main processing. The last operation of the neural
network returns a tensor consisting of 57 matrices. However, this
last op is just a concatenation of two different tensors:
<b>heatmaps</b> and <b>PAF's</b>. The understanding of these two tensors is
essential.  
</p>


<div class="figure">
<p><img src="./images/hm_paf.png" alt="hm_paf.png" />
</p>
</div>
<ol class="org-ol">
<li><p>
A <b>heatmap</b> is a matrix that stores the confidence the network has
that a certain pixel contains a certain part. There are <b>18 (+1)</b>
<b>heatmaps</b> associated with each one of the parts and indexed as we
showed in the drawing of the skeletons. We will extract the
location of the body parts out of these 18 matrices.
</p>


<div class="figure">
<p><img src="./images/heatmap.png" alt="heatmap.png" />
</p>
</div></li>
<li><p>
<b>PAFs</b> (<i>Part Affinity Fields</i>) are matrices that give information
about the position and orientation of pairs. They come in
couples: for each part we have a PAF in the ‘x’ direction and a
PAF in the ‘y’ direction. There are 38 PAFs associated with each
one of the pairs and indexed as we showed in the drawing of the
skeletons. We will associate couples of parts into pairs thanks
to these 38 matrices.
</p>


<div class="figure">
<p><img src="./images/paf.png" alt="paf.png" />
</p>
</div></li>
</ol>
<p>
Code implementation:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">import</span> tensorflow <span style="color: #0000FF;">as</span> tf

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">get tensors</span>
<span style="color: #BA36A5;">inputs</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'inputs:0'</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">heatmaps_tensor</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'Mconv7_stage6_L2/BiasAdd:0'</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">pafs_tensor</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'Mconv7_stage6_L1/BiasAdd:0'</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">forward pass</span>
<span style="color: #0000FF;">with</span> tf.Session<span style="color: #707183;">()</span> <span style="color: #0000FF;">as</span> sess:
    <span style="color: #BA36A5;">heatmaps</span>, <span style="color: #BA36A5;">pafs</span> = sess.run<span style="color: #707183;">(</span><span style="color: #7388D6;">[</span>heatmaps_tensor, pafs_tensor<span style="color: #7388D6;">]</span>, feed_dict=<span style="color: #7388D6;">{</span>
        inputs: image
<span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org9b11998" class="outline-4">
<h4 id="org9b11998"><span class="section-number-4">2.2.3</span> Non Maximum Suppression</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
Next step is detecting the parts in the image.
</p>

<p>
We need to extract parts locations out of a heatmap. Or, in other
words, we need to extract points out of a function. What are these
points? The local maximums.
</p>


<div class="figure">
<p><img src="./images/nms.png" alt="nms.png" />
</p>
</div>

<p>
We apply a non-maximum suppression (NMS) algorithm to get those peaks.
</p>
<ol class="org-ol">
<li>Start in the first pixel of the heatmap.</li>
<li>Surround the pixel with a window of side 5 and find the maximum value in that area.</li>
<li>Substitute the value of the center pixel for that maximum</li>
<li>Slide the window one pixel and repeat these steps after we’ve covered the entire heatmap.</li>
<li>Compare the result with the original heatmap. Those pixels staying
with same value are the peaks we are looking for. Suppress the
other pixels setting them with a value of 0</li>
</ol>

<p>
After all the process, the non-zero pixels denote the location of the
part candidates.
</p>

<ul class="org-ul">
<li>Source code</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">from</span> scipy.ndimage.filters <span style="color: #0000FF;">import</span> maximum <span style="color: #006FE0;">filter</span>

<span style="color: #BA36A5;">part_candidates</span> = heatmap*<span style="color: #707183;">(</span>heatmap == maximum_filter<span style="color: #7388D6;">(</span>heatmap, footprint=np.ones<span style="color: #909183;">(</span><span style="color: #709870;">(</span>window_size, window_size<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge0efd61" class="outline-4">
<h4 id="orge0efd61"><span class="section-number-4">2.2.4</span> Bipartite graph</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Now that we have found the candidates for each one of the body parts,
we need to connect them to form pairs. And this is where graph theory
steps into.
</p>

<p>
Say that, for a given image, we have located a set of neck candidates
and a set of right hip candidates. For each neck there is a possible
association, or connection candidate, with each one of the right
hips. So, what we have, is a <a href="https://en.wikipedia.org/wiki/Complete_bipartite_graph">complete bipartite graph</a>, where the
vertices are the part candidates, and the edges are the connection
candidates.
</p>


<div class="figure">
<p><img src="./images/bipartite_graph.png" alt="bipartite_graph.png" />
</p>
</div>

<p>
How can we find the right connections? Finding the best matching
between vertices of a bipartite graph is a well-known problem in graph
theory known as the <a href="https://en.wikipedia.org/wiki/Assignment_problem">assignment problem</a>. In order to solve it, each
edge on the graph should have a weight. 
</p>
</div>
</div>
<div id="outline-container-org2beee76" class="outline-4">
<h4 id="org2beee76"><span class="section-number-4">2.2.5</span> Line Integral</h4>
<div class="outline-text-4" id="text-2-2-5">

<div class="figure">
<p><img src="./images/line_integral.png" alt="line_integral.png" />
</p>
</div>
<ul class="org-ul">
<li>The right connections can be found out by using line integral over PAF's</li>
<li><p>
<a href="https://en.wikipedia.org/wiki/Line_integral">Line Integral</a> measures the effect of a given field (in our case, the
Part Affinity Fields) along a given curve (in our case, the possible
connections between part candidates).
(Ref: <a href="https://www.youtube.com/watch?v=uXjQ8yc9Pdg">Khan Academy</a>)
</p>


<div class="figure">
<p><img src="./images/line_integral2.png" alt="line_integral2.png" />
</p>
</div></li>
<li>The line integral will give each connection a score, that will be
saved in a weighted bipartite graph and will allow us to solve the
assignment problem</li>
</ul>
<blockquote>
<p>
Note: in the code, we approximate the line integral by taking samples
of the dot product and sum them all.
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">import</span> math
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">building the vectors</span>
<span style="color: #BA36A5;">dx</span>, <span style="color: #BA36A5;">dy</span> = x2 &#8212; x1, y2 &#8212; y1
<span style="color: #BA36A5;">normVec</span> = math.sqrt<span style="color: #707183;">(</span>dx ** 2 + dy ** 2<span style="color: #707183;">)</span>
<span style="color: #BA36A5;">vx</span>, <span style="color: #BA36A5;">vy</span> = dx/normVec, dy/normVec

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">sampling</span>
<span style="color: #BA36A5;">num_samples</span> = 10
<span style="color: #BA36A5;">xs</span> = np.arange<span style="color: #707183;">(</span>x1, x2, dx/num_samples<span style="color: #707183;">)</span>.astype<span style="color: #707183;">(</span>np.int8<span style="color: #707183;">)</span>
<span style="color: #BA36A5;">ys</span> = np.arange<span style="color: #707183;">(</span>y1, y2, dy/num_samples<span style="color: #707183;">)</span>.astype<span style="color: #707183;">(</span>np.int8<span style="color: #707183;">)</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">evaluating on the field</span>
<span style="color: #BA36A5;">pafXs</span> = pafX<span style="color: #707183;">[</span>ys, xs<span style="color: #707183;">]</span>
<span style="color: #BA36A5;">pafYs</span> = pafY<span style="color: #707183;">[</span>ys, xs<span style="color: #707183;">]</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">integral</span>
<span style="color: #BA36A5;">score</span> = <span style="color: #006FE0;">sum</span><span style="color: #707183;">(</span>pafXs * vx + pafYs * vy<span style="color: #707183;">)</span> / num_samples
</pre>
</div>
</div>
</div>
<div id="outline-container-org0e631fc" class="outline-4">
<h4 id="org0e631fc"><span class="section-number-4">2.2.6</span> Assignment</h4>
<div class="outline-text-4" id="text-2-2-6">
<ul class="org-ul">
<li>Now, the weighted bipartite graph shows all connections between
candidates of two parts and holds score for every connection.</li>
<li>The next step is to find the connection that has maximum total
score. Steps given below:
<ol class="org-ol">
<li>Sort each possible connection by its score.</li>
<li>The connection with the highest score is indeed a final connection.</li>
<li>Move to next possible connection. If no parts of this connection
have been assigned to a final connection before, this is a final
connection.</li>
<li>Repeat the step 3 until we are done.</li>
</ol></li>
</ul>


<div class="figure">
<p><img src="./images/assignment.png" alt="assignment.png" />
</p>
</div>
<ul class="org-ul">
<li>As you see, there may be part candidates that will finally not fit into a pair.</li>
<li><p>
Source Code
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">connection</span> = <span style="color: #707183;">[]</span>
<span style="color: #BA36A5;">used_idx1</span>, <span style="color: #BA36A5;">used_idx2</span> = <span style="color: #707183;">[]</span>, <span style="color: #707183;">[]</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">sort possible connections by score, from maximum to minimum</span>
<span style="color: #0000FF;">for</span> conn_candidate <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">sorted</span><span style="color: #707183;">(</span>connection_temp, key=<span style="color: #0000FF;">lambda</span> x: x<span style="color: #7388D6;">[</span><span style="color: #008000;">'score'</span><span style="color: #7388D6;">]</span>, reverse=<span style="color: #D0372D;">True</span><span style="color: #707183;">)</span>:
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">check not connected</span>
    <span style="color: #0000FF;">if</span> conn_candidate<span style="color: #707183;">[</span><span style="color: #008000;">'idx'</span><span style="color: #707183;">][</span>0<span style="color: #707183;">]</span> <span style="color: #0000FF;">in</span> used_idx1 <span style="color: #0000FF;">or</span> conn_candidate<span style="color: #707183;">[</span><span style="color: #008000;">'idx'</span><span style="color: #707183;">][</span>1<span style="color: #707183;">]</span> <span style="color: #0000FF;">in</span> used_idx2:
        <span style="color: #0000FF;">continue</span>
    connection.append<span style="color: #707183;">(</span>conn_candidate<span style="color: #707183;">)</span>
    used_idx1.append<span style="color: #707183;">(</span>conn_candidate<span style="color: #7388D6;">[</span><span style="color: #008000;">'idx'</span><span style="color: #7388D6;">][</span>0<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
    used_idx2.append<span style="color: #707183;">(</span>conn_candidate<span style="color: #7388D6;">[</span><span style="color: #008000;">'idx'</span><span style="color: #7388D6;">][</span>1<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8f5ff66" class="outline-4">
<h4 id="org8f5ff66"><span class="section-number-4">2.2.7</span> Merging</h4>
<div class="outline-text-4" id="text-2-2-7">
<ul class="org-ul">
<li>final step is to transform these detected connections into the final skeletons</li>
<li>We will start with a naive assumption: at first, every connection
belongs to a different human. This way, we have the same number of
humans as connections we have detected</li>
<li><p>
Let Humans be a collection of sets <code>{H1, H2, ..., Hk}</code>. Each one of
these sets — that is, each human — contains, at first, two parts (a
pair). And let’s describe a part as a tuple of an index, a
coordinate in the <code>‘x’</code> direction and a coordinate in the <code>‘y’</code>
direction.
</p>


<div class="figure">
<p><img src="./images/merging.png" alt="merging.png" />
</p>
</div></li>
<li><p>
if humans H1 and H2 share a part index with the same coordinates,
they are sharing the same part! H1 and H2 are, therefore, the same
humans. So we merge both sets into H1 and remove H2.
</p>


<div class="figure">
<p><img src="./images/merging2.png" alt="merging2.png" />
</p>
</div></li>
<li>We continue to do this for every couple of humans until no couple share a part.</li>
</ul>

<blockquote>
<p>
Note: in the code, for some sensible reasons, we first define a human
as a set of connections, not as set of parts. After all the merging is
done, we finally describe a human as a set of parts.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">from</span> collections <span style="color: #0000FF;">import</span> defaultdict
<span style="color: #0000FF;">import</span> itertools

<span style="color: #BA36A5;">no_merge_cache</span> = defaultdict<span style="color: #707183;">(</span><span style="color: #006FE0;">list</span><span style="color: #707183;">)</span>
<span style="color: #BA36A5;">empty_set</span> = <span style="color: #006FE0;">set</span><span style="color: #707183;">()</span>

<span style="color: #0000FF;">while</span> <span style="color: #D0372D;">True</span>:
    <span style="color: #BA36A5;">is_merged</span> = <span style="color: #D0372D;">False</span>

    <span style="color: #0000FF;">for</span> h1, h2 <span style="color: #0000FF;">in</span> itertools.combinations<span style="color: #707183;">(</span>connections_by_human.keys<span style="color: #7388D6;">()</span>, 2<span style="color: #707183;">)</span>:
        <span style="color: #0000FF;">for</span> c1, c2 <span style="color: #0000FF;">in</span> itertools.product<span style="color: #707183;">(</span>connections_by_human<span style="color: #7388D6;">[</span>h1<span style="color: #7388D6;">]</span>, connections_by_human<span style="color: #7388D6;">[</span>h2<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>:
            <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">if two humans share a part (same part idx and coordinates), merge those humans</span>
            <span style="color: #0000FF;">if</span> <span style="color: #006FE0;">set</span><span style="color: #707183;">(</span>c1<span style="color: #7388D6;">[</span><span style="color: #008000;">'partCoordsAndIdx'</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span> &amp; <span style="color: #006FE0;">set</span><span style="color: #707183;">(</span>c2<span style="color: #7388D6;">[</span><span style="color: #008000;">'partCoordsAndIdx'</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span> != empty_set:
                <span style="color: #BA36A5;">is_merged</span> = <span style="color: #D0372D;">True</span>
                <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">extend human1 connections with human2 connections</span>
                connections_by_human<span style="color: #707183;">[</span>h1<span style="color: #707183;">]</span>.extend<span style="color: #707183;">(</span>connections_by_human<span style="color: #7388D6;">[</span>h2<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
                connections_by_human.pop<span style="color: #707183;">(</span>h2<span style="color: #707183;">)</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">delete human2</span>
                <span style="color: #0000FF;">break</span>

    <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> is_merged: <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">if no more mergings are possible, then break</span>
        <span style="color: #0000FF;">break</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">describe humans as a set of parts, not as a set of connections</span>
<span style="color: #BA36A5;">humans</span> = <span style="color: #707183;">[</span>human_conns_to_human_parts<span style="color: #7388D6;">(</span>human_conns<span style="color: #7388D6;">)</span> <span style="color: #0000FF;">for</span> human_conns <span style="color: #0000FF;">in</span> connections_by_human.values<span style="color: #7388D6;">()</span><span style="color: #707183;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org650c0c3" class="outline-4">
<h4 id="org650c0c3"><span class="section-number-4">2.2.8</span> Output</h4>
<div class="outline-text-4" id="text-2-2-8">
<p>
Finally what you get is a collection of human sets, where each human
is a set of parts, where each part contains its index, its relative
coordinates and its score.
</p>
</div>
</div>
</div>
<div id="outline-container-orgadf3276" class="outline-3">
<h3 id="orgadf3276"><span class="section-number-3">2.3</span> Github Repository</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orgd43eb2d" class="outline-4">
<h4 id="orgd43eb2d"><span class="section-number-4">2.3.1</span> Installation</h4>
<div class="outline-text-4" id="text-2-3-1">
</div>
<ol class="org-ol">
<li><a id="org7886053"></a>Dependencies<br />
<div class="outline-text-5" id="text-2-3-1-1">
<ul class="org-ul">
<li>Python 3</li>
<li>TensorFlow</li>
<li>OpenCV</li>
<li>Numpy</li>
<li>Scipy</li>
<li>Matplotlib installed.</li>
</ul>
</div>
</li>
<li><a id="orge94d196"></a>Build the code<br />
<div class="outline-text-5" id="text-2-3-1-2">
<div class="org-src-container">
<pre class="src src-sh">git clone https://gist.github.com/alesolano/b073d8ec9603246f766f9f15d002f4f4 openpose_pipeline
<span style="color: #006FE0;">cd</span> openpose_pipeline
mkdir models
<span style="color: #006FE0;">cd</span> models
wget https://www.dropbox.com/s/2dw1oz9l9hi9avg/optimized_openpose.pb
<span style="color: #006FE0;">cd</span> ..
python inference.py --imgpath /path/to/your/img
</pre>
</div>
</div>
</li>
<li><a id="org88500d3"></a>Main files from the repo<br />
<ol class="org-ol">
<li><a id="orgae5f014"></a>inference.py<br />
<div class="outline-text-6" id="text-2-3-1-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #036A07;">'''</span>
<span style="color: #036A07;">All code is highly based on Ildoo Kim's code (https://github.com/ildoonet/tf-openpose)</span>
<span style="color: #036A07;">and derived from the OpenPose Library (https://github.com/CMU-Perceptual-Computing-Lab/openpose/blob/master/LICENSE)</span>
<span style="color: #036A07;">'''</span>

<span style="color: #0000FF;">import</span> tensorflow <span style="color: #0000FF;">as</span> tf
<span style="color: #0000FF;">import</span> cv2
<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> argparse

<span style="color: #0000FF;">from</span> common <span style="color: #0000FF;">import</span> estimate_pose, draw_humans, read_imgfile

<span style="color: #0000FF;">import</span> time

<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">'__main__'</span>:
    <span style="color: #BA36A5;">parser</span> = argparse.ArgumentParser<span style="color: #707183;">(</span>description=<span style="color: #008000;">'Tensorflow Openpose Inference'</span><span style="color: #707183;">)</span>
    parser.add_argument<span style="color: #707183;">(</span><span style="color: #008000;">'--imgpath'</span>, <span style="color: #006FE0;">type</span>=<span style="color: #006FE0;">str</span>, default=<span style="color: #008000;">'./images/wywh.jpg'</span><span style="color: #707183;">)</span>
    parser.add_argument<span style="color: #707183;">(</span><span style="color: #008000;">'--input-width'</span>, <span style="color: #006FE0;">type</span>=<span style="color: #006FE0;">int</span>, default=656<span style="color: #707183;">)</span>
    parser.add_argument<span style="color: #707183;">(</span><span style="color: #008000;">'--input-height'</span>, <span style="color: #006FE0;">type</span>=<span style="color: #006FE0;">int</span>, default=368<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">args</span> = parser.parse_args<span style="color: #707183;">()</span>

    <span style="color: #BA36A5;">t0</span> = time.time<span style="color: #707183;">()</span>

    tf.reset_default_graph<span style="color: #707183;">()</span>

    <span style="color: #0000FF;">from</span> tensorflow.core.framework <span style="color: #0000FF;">import</span> graph_pb2
    <span style="color: #BA36A5;">graph_def</span> = graph_pb2.GraphDef<span style="color: #707183;">()</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Download model from https://www.dropbox.com/s/2dw1oz9l9hi9avg/optimized_openpose.pb</span>
    <span style="color: #0000FF;">with</span> <span style="color: #006FE0;">open</span><span style="color: #707183;">(</span><span style="color: #008000;">'models/optimized_openpose.pb'</span>, <span style="color: #008000;">'rb'</span><span style="color: #707183;">)</span> <span style="color: #0000FF;">as</span> f:
        graph_def.ParseFromString<span style="color: #707183;">(</span>f.read<span style="color: #7388D6;">()</span><span style="color: #707183;">)</span>
    tf.import_graph_def<span style="color: #707183;">(</span>graph_def, name=<span style="color: #008000;">''</span><span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">t1</span> = time.time<span style="color: #707183;">()</span>
    <span style="color: #0000FF;">print</span><span style="color: #707183;">(</span>t1 - t0<span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">inputs</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'inputs:0'</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">heatmaps_tensor</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'Mconv7_stage6_L2/BiasAdd:0'</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">pafs_tensor</span> = tf.get_default_graph<span style="color: #707183;">()</span>.get_tensor_by_name<span style="color: #707183;">(</span><span style="color: #008000;">'Mconv7_stage6_L1/BiasAdd:0'</span><span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">t2</span> = time.time<span style="color: #707183;">()</span>
    <span style="color: #0000FF;">print</span><span style="color: #707183;">(</span>t2 - t1<span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">image</span> = read_imgfile<span style="color: #707183;">(</span>args.imgpath, args.input_width, args.input_height<span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">t3</span> = time.time<span style="color: #707183;">()</span>
    <span style="color: #0000FF;">print</span><span style="color: #707183;">(</span>t3 - t2<span style="color: #707183;">)</span>

    <span style="color: #0000FF;">with</span> tf.Session<span style="color: #707183;">()</span> <span style="color: #0000FF;">as</span> sess:
        <span style="color: #BA36A5;">heatMat</span>, <span style="color: #BA36A5;">pafMat</span> = sess.run<span style="color: #707183;">(</span><span style="color: #7388D6;">[</span>heatmaps_tensor, pafs_tensor<span style="color: #7388D6;">]</span>, feed_dict=<span style="color: #7388D6;">{</span>
            inputs: image
        <span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

        <span style="color: #BA36A5;">t4</span> = time.time<span style="color: #707183;">()</span>
        <span style="color: #0000FF;">print</span><span style="color: #707183;">(</span>t4 - t3<span style="color: #707183;">)</span>

        <span style="color: #BA36A5;">heatMat</span>, <span style="color: #BA36A5;">pafMat</span> = heatMat<span style="color: #707183;">[</span>0<span style="color: #707183;">]</span>, pafMat<span style="color: #707183;">[</span>0<span style="color: #707183;">]</span>

        <span style="color: #BA36A5;">humans</span> = estimate_pose<span style="color: #707183;">(</span>heatMat, pafMat<span style="color: #707183;">)</span>

        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">display</span>
        <span style="color: #BA36A5;">image</span> = cv2.imread<span style="color: #707183;">(</span>args.imgpath<span style="color: #707183;">)</span>
        <span style="color: #BA36A5;">image_h</span>, <span style="color: #BA36A5;">image_w</span> = image.shape<span style="color: #707183;">[</span>:2<span style="color: #707183;">]</span>
        <span style="color: #BA36A5;">image</span> = draw_humans<span style="color: #707183;">(</span>image, humans<span style="color: #707183;">)</span>

        <span style="color: #BA36A5;">scale</span> = 480.0 / image_h
        <span style="color: #BA36A5;">newh</span>, <span style="color: #BA36A5;">neww</span> = 480, <span style="color: #006FE0;">int</span><span style="color: #707183;">(</span>scale * image_w + 0.5<span style="color: #707183;">)</span>

        <span style="color: #BA36A5;">image</span> = cv2.resize<span style="color: #707183;">(</span>image, <span style="color: #7388D6;">(</span>neww, newh<span style="color: #7388D6;">)</span>, interpolation=cv2.INTER_AREA<span style="color: #707183;">)</span>

        cv2.imshow<span style="color: #707183;">(</span><span style="color: #008000;">'result'</span>, image<span style="color: #707183;">)</span>
        <span style="color: #BA36A5;">t5</span> = time.time<span style="color: #707183;">()</span>
        <span style="color: #0000FF;">print</span><span style="color: #707183;">(</span>t5 - t4<span style="color: #707183;">)</span>
        cv2.waitKey<span style="color: #707183;">(</span>0<span style="color: #707183;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org329c4c0"></a>common.py<br />
<div class="outline-text-6" id="text-2-3-1-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #036A07;">'''</span>
<span style="color: #036A07;">All code is highly based on Ildoo Kim's code (https://github.com/ildoonet/tf-openpose)</span>
<span style="color: #036A07;">and derived from the OpenPose Library (https://github.com/CMU-Perceptual-Computing-Lab/openpose/blob/master/LICENSE)</span>
<span style="color: #036A07;">'''</span>

<span style="color: #0000FF;">from</span> collections <span style="color: #0000FF;">import</span> defaultdict
<span style="color: #0000FF;">from</span> enum <span style="color: #0000FF;">import</span> Enum
<span style="color: #0000FF;">import</span> math

<span style="color: #0000FF;">import</span> numpy <span style="color: #0000FF;">as</span> np
<span style="color: #0000FF;">import</span> itertools
<span style="color: #0000FF;">import</span> cv2
<span style="color: #0000FF;">from</span> scipy.ndimage.filters <span style="color: #0000FF;">import</span> maximum_filter


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">CocoPart</span><span style="color: #707183;">(</span>Enum<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">Nose</span> = 0
    <span style="color: #BA36A5;">Neck</span> = 1
    <span style="color: #BA36A5;">RShoulder</span> = 2
    <span style="color: #BA36A5;">RElbow</span> = 3
    <span style="color: #BA36A5;">RWrist</span> = 4
    <span style="color: #BA36A5;">LShoulder</span> = 5
    <span style="color: #BA36A5;">LElbow</span> = 6
    <span style="color: #BA36A5;">LWrist</span> = 7
    <span style="color: #BA36A5;">RHip</span> = 8
    <span style="color: #BA36A5;">RKnee</span> = 9
    <span style="color: #BA36A5;">RAnkle</span> = 10
    <span style="color: #BA36A5;">LHip</span> = 11
    <span style="color: #BA36A5;">LKnee</span> = 12
    <span style="color: #BA36A5;">LAnkle</span> = 13
    <span style="color: #BA36A5;">REye</span> = 14
    <span style="color: #BA36A5;">LEye</span> = 15
    <span style="color: #BA36A5;">REar</span> = 16
    <span style="color: #BA36A5;">LEar</span> = 17
    <span style="color: #BA36A5;">Background</span> = 18

<span style="color: #BA36A5;">CocoPairs</span> = <span style="color: #707183;">[</span>
    <span style="color: #7388D6;">(</span>1, 2<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>1, 5<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>2, 3<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>3, 4<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>5, 6<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>6, 7<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>1, 8<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>8, 9<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>9, 10<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>1, 11<span style="color: #7388D6;">)</span>,
    <span style="color: #7388D6;">(</span>11, 12<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>12, 13<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>1, 0<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>0, 14<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>14, 16<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>0, 15<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>15, 17<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>2, 16<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>5, 17<span style="color: #7388D6;">)</span>
<span style="color: #707183;">]</span>   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">= 19</span>
<span style="color: #BA36A5;">CocoPairsRender</span> = CocoPairs<span style="color: #707183;">[</span>:-2<span style="color: #707183;">]</span>
<span style="color: #BA36A5;">CocoPairsNetwork</span> = <span style="color: #707183;">[</span>
    <span style="color: #7388D6;">(</span>12, 13<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>20, 21<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>14, 15<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>16, 17<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>22, 23<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>24, 25<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>0, 1<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>2, 3<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>4, 5<span style="color: #7388D6;">)</span>,
    <span style="color: #7388D6;">(</span>6, 7<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>8, 9<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>10, 11<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>28, 29<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>30, 31<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>34, 35<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>32, 33<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>36, 37<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>18, 19<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>26, 27<span style="color: #7388D6;">)</span>
 <span style="color: #707183;">]</span>  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">= 19</span>

<span style="color: #BA36A5;">CocoColors</span> = <span style="color: #707183;">[</span><span style="color: #7388D6;">[</span>255, 0, 0<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>255, 85, 0<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>255, 170, 0<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>255, 255, 0<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>170, 255, 0<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>85, 255, 0<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>0, 255, 0<span style="color: #7388D6;">]</span>,
              <span style="color: #7388D6;">[</span>0, 255, 85<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>0, 255, 170<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>0, 255, 255<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>0, 170, 255<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>0, 85, 255<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>0, 0, 255<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>85, 0, 255<span style="color: #7388D6;">]</span>,
              <span style="color: #7388D6;">[</span>170, 0, 255<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>255, 0, 255<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>255, 0, 170<span style="color: #7388D6;">]</span>, <span style="color: #7388D6;">[</span>255, 0, 85<span style="color: #7388D6;">]</span><span style="color: #707183;">]</span>


<span style="color: #BA36A5;">NMS_Threshold</span> = 0.1
<span style="color: #BA36A5;">InterMinAbove_Threshold</span> = 6
<span style="color: #BA36A5;">Inter_Threashold</span> = 0.1
<span style="color: #BA36A5;">Min_Subset_Cnt</span> = 4
<span style="color: #BA36A5;">Min_Subset_Score</span> = 0.8
<span style="color: #BA36A5;">Max_Human</span> = 96


<span style="color: #0000FF;">def</span> <span style="color: #006699;">human_conns_to_human_parts</span><span style="color: #707183;">(</span>human_conns, heatMat<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">human_parts</span> = defaultdict<span style="color: #707183;">(</span><span style="color: #0000FF;">lambda</span>: <span style="color: #D0372D;">None</span><span style="color: #707183;">)</span>
    <span style="color: #0000FF;">for</span> conn <span style="color: #0000FF;">in</span> human_conns:
        human_parts<span style="color: #707183;">[</span>conn<span style="color: #7388D6;">[</span><span style="color: #008000;">'partIdx'</span><span style="color: #7388D6;">][</span>0<span style="color: #7388D6;">]</span><span style="color: #707183;">]</span> = <span style="color: #707183;">(</span>
            conn<span style="color: #7388D6;">[</span><span style="color: #008000;">'partIdx'</span><span style="color: #7388D6;">][</span>0<span style="color: #7388D6;">]</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">part index</span>
            <span style="color: #7388D6;">(</span>conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p1'</span><span style="color: #909183;">][</span>0<span style="color: #909183;">]</span> / heatMat.shape<span style="color: #909183;">[</span>2<span style="color: #909183;">]</span>, conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p1'</span><span style="color: #909183;">][</span>1<span style="color: #909183;">]</span> / heatMat.shape<span style="color: #909183;">[</span>1<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">relative coordinates</span>
            heatMat<span style="color: #7388D6;">[</span>conn<span style="color: #909183;">[</span><span style="color: #008000;">'partIdx'</span><span style="color: #909183;">][</span>0<span style="color: #909183;">]</span>, conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p1'</span><span style="color: #909183;">][</span>1<span style="color: #909183;">]</span>, conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p1'</span><span style="color: #909183;">][</span>0<span style="color: #909183;">]</span><span style="color: #7388D6;">]</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">score</span>
            <span style="color: #707183;">)</span>
        human_parts<span style="color: #707183;">[</span>conn<span style="color: #7388D6;">[</span><span style="color: #008000;">'partIdx'</span><span style="color: #7388D6;">][</span>1<span style="color: #7388D6;">]</span><span style="color: #707183;">]</span> = <span style="color: #707183;">(</span>
            conn<span style="color: #7388D6;">[</span><span style="color: #008000;">'partIdx'</span><span style="color: #7388D6;">][</span>1<span style="color: #7388D6;">]</span>,
            <span style="color: #7388D6;">(</span>conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p2'</span><span style="color: #909183;">][</span>0<span style="color: #909183;">]</span> / heatMat.shape<span style="color: #909183;">[</span>2<span style="color: #909183;">]</span>, conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p2'</span><span style="color: #909183;">][</span>1<span style="color: #909183;">]</span> / heatMat.shape<span style="color: #909183;">[</span>1<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span>,
            heatMat<span style="color: #7388D6;">[</span>conn<span style="color: #909183;">[</span><span style="color: #008000;">'partIdx'</span><span style="color: #909183;">][</span>1<span style="color: #909183;">]</span>, conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p2'</span><span style="color: #909183;">][</span>1<span style="color: #909183;">]</span>, conn<span style="color: #909183;">[</span><span style="color: #008000;">'coord_p2'</span><span style="color: #909183;">][</span>0<span style="color: #909183;">]</span><span style="color: #7388D6;">]</span>
            <span style="color: #707183;">)</span>
    <span style="color: #0000FF;">return</span> human_parts


<span style="color: #0000FF;">def</span> <span style="color: #006699;">non_max_suppression</span><span style="color: #707183;">(</span>heatmap, window_size=3, threshold=NMS_Threshold<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">heatmap</span><span style="color: #707183;">[</span>heatmap &lt; threshold<span style="color: #707183;">]</span> = 0 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">set low values to 0</span>
    <span style="color: #BA36A5;">part_candidates</span> = heatmap*<span style="color: #707183;">(</span>heatmap == maximum_filter<span style="color: #7388D6;">(</span>heatmap, footprint=np.ones<span style="color: #909183;">(</span><span style="color: #709870;">(</span>window_size, window_size<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
    <span style="color: #0000FF;">return</span> part_candidates


<span style="color: #0000FF;">def</span> <span style="color: #006699;">estimate_pose</span><span style="color: #707183;">(</span>heatMat, pafMat<span style="color: #707183;">)</span>:
    <span style="color: #0000FF;">if</span> heatMat.shape<span style="color: #707183;">[</span>2<span style="color: #707183;">]</span> == 19:
        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">transform from [height, width, n_parts] to [n_parts, height, width]</span>
        <span style="color: #BA36A5;">heatMat</span> = np.rollaxis<span style="color: #707183;">(</span>heatMat, 2, 0<span style="color: #707183;">)</span>
    <span style="color: #0000FF;">if</span> pafMat.shape<span style="color: #707183;">[</span>2<span style="color: #707183;">]</span> == 38:
        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">transform from [height, width, 2*n_pairs] to [2*n_pairs, height, width]</span>
        <span style="color: #BA36A5;">pafMat</span> = np.rollaxis<span style="color: #707183;">(</span>pafMat, 2, 0<span style="color: #707183;">)</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">reliability issue.</span>
    <span style="color: #BA36A5;">heatMat</span> = heatMat - heatMat.<span style="color: #006FE0;">min</span><span style="color: #707183;">(</span>axis=1<span style="color: #707183;">)</span>.<span style="color: #006FE0;">min</span><span style="color: #707183;">(</span>axis=1<span style="color: #707183;">)</span>.reshape<span style="color: #707183;">(</span>19, 1, 1<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">heatMat</span> = heatMat - heatMat.<span style="color: #006FE0;">min</span><span style="color: #707183;">(</span>axis=2<span style="color: #707183;">)</span>.reshape<span style="color: #707183;">(</span>19, heatMat.shape<span style="color: #7388D6;">[</span>1<span style="color: #7388D6;">]</span>, 1<span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">_NMS_Threshold</span> = <span style="color: #006FE0;">max</span><span style="color: #707183;">(</span>np.average<span style="color: #7388D6;">(</span>heatMat<span style="color: #7388D6;">)</span> * 4.0, NMS_Threshold<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">_NMS_Threshold</span> = <span style="color: #006FE0;">min</span><span style="color: #707183;">(</span>_NMS_Threshold, 0.3<span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">coords</span> = <span style="color: #707183;">[]</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">for each part index, it stores coordinates of candidates</span>
    <span style="color: #0000FF;">for</span> heatmap <span style="color: #0000FF;">in</span> heatMat<span style="color: #707183;">[</span>:-1<span style="color: #707183;">]</span>: <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">remove background</span>
        <span style="color: #BA36A5;">part_candidates</span> = non_max_suppression<span style="color: #707183;">(</span>heatmap, 5, _NMS_Threshold<span style="color: #707183;">)</span>
        coords.append<span style="color: #707183;">(</span>np.where<span style="color: #7388D6;">(</span>part_candidates &gt;= _NMS_Threshold<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">connection_all</span> = <span style="color: #707183;">[]</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">all connections detected. no information about what humans they belong to</span>
    <span style="color: #0000FF;">for</span> <span style="color: #707183;">(</span>idx1, idx2<span style="color: #707183;">)</span>, <span style="color: #707183;">(</span>paf_x_idx, paf_y_idx<span style="color: #707183;">)</span> <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">zip</span><span style="color: #707183;">(</span>CocoPairs, CocoPairsNetwork<span style="color: #707183;">)</span>:
        <span style="color: #BA36A5;">connection</span> = estimate_pose_pair<span style="color: #707183;">(</span>coords, idx1, idx2, pafMat<span style="color: #7388D6;">[</span>paf_x_idx<span style="color: #7388D6;">]</span>, pafMat<span style="color: #7388D6;">[</span>paf_y_idx<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
        connection_all.extend<span style="color: #707183;">(</span>connection<span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">conns_by_human</span> = <span style="color: #006FE0;">dict</span><span style="color: #707183;">()</span>
    <span style="color: #0000FF;">for</span> idx, c <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">enumerate</span><span style="color: #707183;">(</span>connection_all<span style="color: #707183;">)</span>:
        <span style="color: #BA36A5;">conns_by_human</span><span style="color: #707183;">[</span><span style="color: #008000;">'human_%d'</span> % idx<span style="color: #707183;">]</span> = <span style="color: #707183;">[</span>c<span style="color: #707183;">]</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">at first, all connections belong to different humans</span>

    <span style="color: #BA36A5;">no_merge_cache</span> = defaultdict<span style="color: #707183;">(</span><span style="color: #006FE0;">list</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">empty_set</span> = <span style="color: #006FE0;">set</span><span style="color: #707183;">()</span>
    <span style="color: #0000FF;">while</span> <span style="color: #D0372D;">True</span>:
        <span style="color: #BA36A5;">is_merged</span> = <span style="color: #D0372D;">False</span>
        <span style="color: #0000FF;">for</span> h1, h2 <span style="color: #0000FF;">in</span> itertools.combinations<span style="color: #707183;">(</span>conns_by_human.keys<span style="color: #7388D6;">()</span>, 2<span style="color: #707183;">)</span>:
            <span style="color: #0000FF;">if</span> h1 == h2:
                <span style="color: #0000FF;">continue</span>
            <span style="color: #0000FF;">if</span> h2 <span style="color: #0000FF;">in</span> no_merge_cache<span style="color: #707183;">[</span>h1<span style="color: #707183;">]</span>:
                <span style="color: #0000FF;">continue</span>
            <span style="color: #0000FF;">for</span> c1, c2 <span style="color: #0000FF;">in</span> itertools.product<span style="color: #707183;">(</span>conns_by_human<span style="color: #7388D6;">[</span>h1<span style="color: #7388D6;">]</span>, conns_by_human<span style="color: #7388D6;">[</span>h2<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>:
                <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">if two humans share a part (same part idx and coordinates), merge those humans</span>
                <span style="color: #0000FF;">if</span> <span style="color: #006FE0;">set</span><span style="color: #707183;">(</span>c1<span style="color: #7388D6;">[</span><span style="color: #008000;">'uPartIdx'</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span> &amp; <span style="color: #006FE0;">set</span><span style="color: #707183;">(</span>c2<span style="color: #7388D6;">[</span><span style="color: #008000;">'uPartIdx'</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span> != empty_set:
                    <span style="color: #BA36A5;">is_merged</span> = <span style="color: #D0372D;">True</span>
                    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">extend human1 connectios with human2 connections</span>
                    conns_by_human<span style="color: #707183;">[</span>h1<span style="color: #707183;">]</span>.extend<span style="color: #707183;">(</span>conns_by_human<span style="color: #7388D6;">[</span>h2<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
                    conns_by_human.pop<span style="color: #707183;">(</span>h2<span style="color: #707183;">)</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">delete human2</span>
                    <span style="color: #0000FF;">break</span>
            <span style="color: #0000FF;">if</span> is_merged:
                no_merge_cache.pop<span style="color: #707183;">(</span>h1, <span style="color: #D0372D;">None</span><span style="color: #707183;">)</span>
                <span style="color: #0000FF;">break</span>
            <span style="color: #0000FF;">else</span>:
                no_merge_cache<span style="color: #707183;">[</span>h1<span style="color: #707183;">]</span>.append<span style="color: #707183;">(</span>h2<span style="color: #707183;">)</span>

        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> is_merged: <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">if no more mergings are possible, then break</span>
            <span style="color: #0000FF;">break</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">reject by subset count</span>
    <span style="color: #BA36A5;">conns_by_human</span> = <span style="color: #707183;">{</span>h: conns <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span>h, conns<span style="color: #7388D6;">)</span> <span style="color: #0000FF;">in</span> conns_by_human.items<span style="color: #7388D6;">()</span> <span style="color: #0000FF;">if</span> <span style="color: #006FE0;">len</span><span style="color: #7388D6;">(</span>conns<span style="color: #7388D6;">)</span> &gt;= Min_Subset_Cnt<span style="color: #707183;">}</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">reject by subset max score</span>
    <span style="color: #BA36A5;">conns_by_human</span> = <span style="color: #707183;">{</span>h: conns <span style="color: #0000FF;">for</span> <span style="color: #7388D6;">(</span>h, conns<span style="color: #7388D6;">)</span> <span style="color: #0000FF;">in</span> conns_by_human.items<span style="color: #7388D6;">()</span> <span style="color: #0000FF;">if</span> <span style="color: #006FE0;">max</span><span style="color: #7388D6;">(</span><span style="color: #909183;">[</span>conn<span style="color: #709870;">[</span><span style="color: #008000;">'score'</span><span style="color: #709870;">]</span> <span style="color: #0000FF;">for</span> conn <span style="color: #0000FF;">in</span> conns<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span> &gt;= Min_Subset_Score<span style="color: #707183;">}</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">list of humans</span>
    <span style="color: #BA36A5;">humans</span> = <span style="color: #707183;">[</span>human_conns_to_human_parts<span style="color: #7388D6;">(</span>human_conns, heatMat<span style="color: #7388D6;">)</span> <span style="color: #0000FF;">for</span> human_conns <span style="color: #0000FF;">in</span> conns_by_human.values<span style="color: #7388D6;">()</span><span style="color: #707183;">]</span>
    <span style="color: #0000FF;">return</span> humans


<span style="color: #0000FF;">def</span> <span style="color: #006699;">estimate_pose_pair</span><span style="color: #707183;">(</span>coords, partIdx1, partIdx2, pafMatX, pafMatY<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">connection_temp</span> = <span style="color: #707183;">[]</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">all possible connections</span>
    <span style="color: #BA36A5;">peak_coord1</span>, <span style="color: #BA36A5;">peak_coord2</span> = coords<span style="color: #707183;">[</span>partIdx1<span style="color: #707183;">]</span>, coords<span style="color: #707183;">[</span>partIdx2<span style="color: #707183;">]</span>

    <span style="color: #0000FF;">for</span> idx1, <span style="color: #707183;">(</span>y1, x1<span style="color: #707183;">)</span> <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">enumerate</span><span style="color: #707183;">(</span><span style="color: #006FE0;">zip</span><span style="color: #7388D6;">(</span>peak_coord1<span style="color: #909183;">[</span>0<span style="color: #909183;">]</span>, peak_coord1<span style="color: #909183;">[</span>1<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>:
        <span style="color: #0000FF;">for</span> idx2, <span style="color: #707183;">(</span>y2, x2<span style="color: #707183;">)</span> <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">enumerate</span><span style="color: #707183;">(</span><span style="color: #006FE0;">zip</span><span style="color: #7388D6;">(</span>peak_coord2<span style="color: #909183;">[</span>0<span style="color: #909183;">]</span>, peak_coord2<span style="color: #909183;">[</span>1<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>:
            <span style="color: #BA36A5;">score</span>, <span style="color: #BA36A5;">count</span> = get_score<span style="color: #707183;">(</span>x1, y1, x2, y2, pafMatX, pafMatY<span style="color: #707183;">)</span>
            <span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span>partIdx1, partIdx2<span style="color: #707183;">)</span> <span style="color: #0000FF;">in</span> <span style="color: #707183;">[</span><span style="color: #7388D6;">(</span>2, 3<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>3, 4<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>5, 6<span style="color: #7388D6;">)</span>, <span style="color: #7388D6;">(</span>6, 7<span style="color: #7388D6;">)</span><span style="color: #707183;">]</span>: <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">arms</span>
                <span style="color: #0000FF;">if</span> count &lt; InterMinAbove_Threshold // 2 <span style="color: #0000FF;">or</span> score &lt;= 0.0:
                    <span style="color: #0000FF;">continue</span>
            <span style="color: #0000FF;">elif</span> count &lt; InterMinAbove_Threshold <span style="color: #0000FF;">or</span> score &lt;= 0.0:
                <span style="color: #0000FF;">continue</span>
            connection_temp.append<span style="color: #707183;">(</span><span style="color: #7388D6;">{</span>
                <span style="color: #008000;">'score'</span>: score,
                <span style="color: #008000;">'coord_p1'</span>: <span style="color: #909183;">(</span>x1, y1<span style="color: #909183;">)</span>,
                <span style="color: #008000;">'coord_p2'</span>: <span style="color: #909183;">(</span>x2, y2<span style="color: #909183;">)</span>,
                <span style="color: #008000;">'idx'</span>: <span style="color: #909183;">(</span>idx1, idx2<span style="color: #909183;">)</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">connection candidate identifier</span>
                <span style="color: #008000;">'partIdx'</span>: <span style="color: #909183;">(</span>partIdx1, partIdx2<span style="color: #909183;">)</span>,
                <span style="color: #008000;">'uPartIdx'</span>: <span style="color: #909183;">(</span><span style="color: #008000;">'{}-{}-{}'</span>.<span style="color: #006FE0;">format</span><span style="color: #709870;">(</span>x1, y1, partIdx1<span style="color: #709870;">)</span>, <span style="color: #008000;">'{}-{}-{}'</span>.<span style="color: #006FE0;">format</span><span style="color: #709870;">(</span>x2, y2, partIdx2<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
            <span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

    <span style="color: #BA36A5;">connection</span> = <span style="color: #707183;">[]</span>
    <span style="color: #BA36A5;">used_idx1</span>, <span style="color: #BA36A5;">used_idx2</span> = <span style="color: #707183;">[]</span>, <span style="color: #707183;">[]</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">sort possible connections by score, from maximum to minimum</span>
    <span style="color: #0000FF;">for</span> conn_candidate <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">sorted</span><span style="color: #707183;">(</span>connection_temp, key=<span style="color: #0000FF;">lambda</span> x: x<span style="color: #7388D6;">[</span><span style="color: #008000;">'score'</span><span style="color: #7388D6;">]</span>, reverse=<span style="color: #D0372D;">True</span><span style="color: #707183;">)</span>:
        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">check not connected</span>
        <span style="color: #0000FF;">if</span> conn_candidate<span style="color: #707183;">[</span><span style="color: #008000;">'idx'</span><span style="color: #707183;">][</span>0<span style="color: #707183;">]</span> <span style="color: #0000FF;">in</span> used_idx1 <span style="color: #0000FF;">or</span> conn_candidate<span style="color: #707183;">[</span><span style="color: #008000;">'idx'</span><span style="color: #707183;">][</span>1<span style="color: #707183;">]</span> <span style="color: #0000FF;">in</span> used_idx2:
            <span style="color: #0000FF;">continue</span>
        connection.append<span style="color: #707183;">(</span>conn_candidate<span style="color: #707183;">)</span>
        used_idx1.append<span style="color: #707183;">(</span>conn_candidate<span style="color: #7388D6;">[</span><span style="color: #008000;">'idx'</span><span style="color: #7388D6;">][</span>0<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
        used_idx2.append<span style="color: #707183;">(</span>conn_candidate<span style="color: #7388D6;">[</span><span style="color: #008000;">'idx'</span><span style="color: #7388D6;">][</span>1<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>

    <span style="color: #0000FF;">return</span> connection


<span style="color: #0000FF;">def</span> <span style="color: #006699;">get_score</span><span style="color: #707183;">(</span>x1, y1, x2, y2, pafMatX, pafMatY<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">num_inter</span> = 10
    <span style="color: #BA36A5;">dx</span>, <span style="color: #BA36A5;">dy</span> = x2 - x1, y2 - y1
    <span style="color: #BA36A5;">normVec</span> = math.sqrt<span style="color: #707183;">(</span>dx ** 2 + dy ** 2<span style="color: #707183;">)</span>

    <span style="color: #0000FF;">if</span> normVec &lt; 1e-4:
        <span style="color: #0000FF;">return</span> 0.0, 0

    <span style="color: #BA36A5;">vx</span>, <span style="color: #BA36A5;">vy</span> = dx / normVec, dy / normVec

    <span style="color: #BA36A5;">xs</span> = np.arange<span style="color: #707183;">(</span>x1, x2, dx / num_inter<span style="color: #707183;">)</span> <span style="color: #0000FF;">if</span> x1 != x2 <span style="color: #0000FF;">else</span> np.full<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>num_inter, <span style="color: #7388D6;">)</span>, x1<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">ys</span> = np.arange<span style="color: #707183;">(</span>y1, y2, dy / num_inter<span style="color: #707183;">)</span> <span style="color: #0000FF;">if</span> y1 != y2 <span style="color: #0000FF;">else</span> np.full<span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>num_inter, <span style="color: #7388D6;">)</span>, y1<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">xs</span> = <span style="color: #707183;">(</span>xs + 0.5<span style="color: #707183;">)</span>.astype<span style="color: #707183;">(</span>np.int8<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">ys</span> = <span style="color: #707183;">(</span>ys + 0.5<span style="color: #707183;">)</span>.astype<span style="color: #707183;">(</span>np.int8<span style="color: #707183;">)</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">without vectorization</span>
    <span style="color: #BA36A5;">pafXs</span> = np.zeros<span style="color: #707183;">(</span>num_inter<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">pafYs</span> = np.zeros<span style="color: #707183;">(</span>num_inter<span style="color: #707183;">)</span>
    <span style="color: #0000FF;">for</span> idx, <span style="color: #707183;">(</span>mx, my<span style="color: #707183;">)</span> <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">enumerate</span><span style="color: #707183;">(</span><span style="color: #006FE0;">zip</span><span style="color: #7388D6;">(</span>xs, ys<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>:
        <span style="color: #BA36A5;">pafXs</span><span style="color: #707183;">[</span>idx<span style="color: #707183;">]</span> = pafMatX<span style="color: #707183;">[</span>my<span style="color: #707183;">][</span>mx<span style="color: #707183;">]</span>
        <span style="color: #BA36A5;">pafYs</span><span style="color: #707183;">[</span>idx<span style="color: #707183;">]</span> = pafMatY<span style="color: #707183;">[</span>my<span style="color: #707183;">][</span>mx<span style="color: #707183;">]</span>

    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">vectorization slow?</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">pafXs = pafMatX[ys, xs]</span>
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">pafYs = pafMatY[ys, xs]</span>

    <span style="color: #BA36A5;">local_scores</span> = pafXs * vx + pafYs * vy
    <span style="color: #BA36A5;">thidxs</span> = local_scores &gt; Inter_Threashold

    <span style="color: #0000FF;">return</span> <span style="color: #006FE0;">sum</span><span style="color: #707183;">(</span>local_scores * thidxs<span style="color: #707183;">)</span>, <span style="color: #006FE0;">sum</span><span style="color: #707183;">(</span>thidxs<span style="color: #707183;">)</span>


<span style="color: #0000FF;">def</span> <span style="color: #006699;">read_imgfile</span><span style="color: #707183;">(</span>path, width, height<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">img</span> = cv2.imread<span style="color: #707183;">(</span>path<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">val_img</span> = preprocess<span style="color: #707183;">(</span>img, width, height<span style="color: #707183;">)</span>
    <span style="color: #0000FF;">return</span> val_img


<span style="color: #0000FF;">def</span> <span style="color: #006699;">preprocess</span><span style="color: #707183;">(</span>img, width, height<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">val_img</span> = cv2.cvtColor<span style="color: #707183;">(</span>img, cv2.COLOR_BGR2RGB<span style="color: #707183;">)</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">cv2 reads in BGR format</span>
    <span style="color: #BA36A5;">val_img</span> = cv2.resize<span style="color: #707183;">(</span>val_img, <span style="color: #7388D6;">(</span>width, height<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">each net accept only a certain size</span>
    <span style="color: #BA36A5;">val_img</span> = val_img.reshape<span style="color: #707183;">(</span><span style="color: #7388D6;">[</span>1, height, width, 3<span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">val_img</span> = val_img.astype<span style="color: #707183;">(</span><span style="color: #006FE0;">float</span><span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">val_img</span> = val_img * <span style="color: #707183;">(</span>2.0 / 255.0<span style="color: #707183;">)</span> - 1.0 <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">image range from -1 to +1</span>
    <span style="color: #0000FF;">return</span> val_img


<span style="color: #0000FF;">def</span> <span style="color: #006699;">draw_humans</span><span style="color: #707183;">(</span>img, human_list<span style="color: #707183;">)</span>:
    <span style="color: #BA36A5;">img_copied</span> = np.copy<span style="color: #707183;">(</span>img<span style="color: #707183;">)</span>
    <span style="color: #BA36A5;">image_h</span>, <span style="color: #BA36A5;">image_w</span> = img_copied.shape<span style="color: #707183;">[</span>:2<span style="color: #707183;">]</span>
    <span style="color: #BA36A5;">centers</span> = <span style="color: #707183;">{}</span>
    <span style="color: #0000FF;">for</span> human <span style="color: #0000FF;">in</span> human_list:
        <span style="color: #BA36A5;">part_idxs</span> = human.keys<span style="color: #707183;">()</span>

        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">draw point</span>
        <span style="color: #0000FF;">for</span> i <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">range</span><span style="color: #707183;">(</span>CocoPart.Background.value<span style="color: #707183;">)</span>:
            <span style="color: #0000FF;">if</span> i <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">in</span> part_idxs:
                <span style="color: #0000FF;">continue</span>
            <span style="color: #BA36A5;">part_coord</span> = human<span style="color: #707183;">[</span>i<span style="color: #707183;">][</span>1<span style="color: #707183;">]</span>
            <span style="color: #BA36A5;">center</span> = <span style="color: #707183;">(</span><span style="color: #006FE0;">int</span><span style="color: #7388D6;">(</span>part_coord<span style="color: #909183;">[</span>0<span style="color: #909183;">]</span> * image_w + 0.5<span style="color: #7388D6;">)</span>, <span style="color: #006FE0;">int</span><span style="color: #7388D6;">(</span>part_coord<span style="color: #909183;">[</span>1<span style="color: #909183;">]</span> * image_h + 0.5<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
            <span style="color: #BA36A5;">centers</span><span style="color: #707183;">[</span>i<span style="color: #707183;">]</span> = center
            cv2.circle<span style="color: #707183;">(</span>img_copied, center, 3, CocoColors<span style="color: #7388D6;">[</span>i<span style="color: #7388D6;">]</span>, thickness=3, lineType=8, shift=0<span style="color: #707183;">)</span>

        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">draw line</span>
        <span style="color: #0000FF;">for</span> pair_order, pair <span style="color: #0000FF;">in</span> <span style="color: #006FE0;">enumerate</span><span style="color: #707183;">(</span>CocoPairsRender<span style="color: #707183;">)</span>:
            <span style="color: #0000FF;">if</span> pair<span style="color: #707183;">[</span>0<span style="color: #707183;">]</span> <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">in</span> part_idxs <span style="color: #0000FF;">or</span> pair<span style="color: #707183;">[</span>1<span style="color: #707183;">]</span> <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">in</span> part_idxs:
                <span style="color: #0000FF;">continue</span>

            <span style="color: #BA36A5;">img_copied</span> = cv2.line<span style="color: #707183;">(</span>img_copied, centers<span style="color: #7388D6;">[</span>pair<span style="color: #909183;">[</span>0<span style="color: #909183;">]</span><span style="color: #7388D6;">]</span>, centers<span style="color: #7388D6;">[</span>pair<span style="color: #909183;">[</span>1<span style="color: #909183;">]</span><span style="color: #7388D6;">]</span>, CocoColors<span style="color: #7388D6;">[</span>pair_order<span style="color: #7388D6;">]</span>, 3<span style="color: #707183;">)</span>

    <span style="color: #0000FF;">return</span> img_copied
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2018-08-12 Sun 00:00</p>
<p class="author">Author: Sarath.M</p>
<p class="date">Created: 2018-08-12 Sun 16:36</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
